<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>çŒœæ­Œè©éŠæˆ²</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #111;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    .lyrics {
      margin-top: 20px;
      line-height: 2em;
    }
    .char {
      display: inline-block;
      width: 1.5em;
      height: 1.5em;
      margin: 2px;
      background-color: black;
      color: black;
      border: 1px solid white;
      transition: 0.2s;
    }
    .space
    {
      display: inline-block;
      width: 1.5em;
      height: 1.5em;
      background-color: black;
      color: black;
      transition: 0.2s;
    }
    .revealed {
      background-color: transparent;
      color: white;
    }
    input {
      padding: 10px;
      font-size: 16px;
      width: 300px;
      margin-top: 20px;
    }
    #log {
      margin-top: 10px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>ğŸµ çŒœæ­Œè©éŠæˆ² ğŸµ</h1>
  <input id="input" placeholder="è¼¸å…¥ä¸€å€‹å­— æˆ– çŒœæ­Œå">
  <div>
    <input type="button" value="æˆ‘æ”¾æ£„/é¡¯ç¤ºæ­Œè©ï¼‹ç­”æ¡ˆ" onclick="show_all()">
  </div>
  <div id="log"></div>
  <div class="lyrics" id="lyrics"></div>
  <div id="guessed"></div>
  <div id="wrong"></div>
  <script>


    const lyricsContainer = document.getElementById("lyrics");
    const log = document.getElementById("log");
    const input = document.getElementById("input");
    const geussed = document.getElementById("guessed");
    const wrong = document.getElementById("wrong");
    let guessedChars = new Set();
    let wrongChars = new Set();
    let guessCount = 0;
    let lyrics;
    let singer = "";
    let full_lyrics = "";
    let songTitle = "";
    let init_needed = true;
    async function get_lyrics()
    {
      var r = await fetch("https://lyricsmelon.948794harvey.workers.dev/").then(response => response.json());

      if(!r || !r["lyrics"] || !r["singer"] || !r["song_name"])
      {
        r = get_lyrics()
      }

      return r;
    }

    function restart()
    {
      init_needed = true;
      renderLyrics();
    }

    // åˆå§‹åŒ–æ­Œè©æ¬„ä½
    async function renderLyrics() {
      if(init_needed)
      {
        lyricsContainer.innerHTML = `<span>è«‹ç¨ç­‰</span>`;
        var question = await get_lyrics();
        guessedChars = new Set();
        wrongChars = new Set();
        guessCount = 0;
        lyrics = question["lyrics"];
        singer = question["singer"];
        full_lyrics = lyrics.join("");
        songTitle = question["song_name"];
        init_needed = false;
        // console.log(question)
        // console.log("lyrics",lyrics);
      }
      lyricsContainer.innerHTML = '';
      for (let sentence of lyrics) {
        for(let char of sentence)
        {
          const span = document.createElement('span');
          if(char === ' ')
          {
            span.classList.add('space');
            span.textContent = 'ã€€'; // å…¨å½¢ç©ºç™½ç¶­æŒå¯¬åº¦
          }
          else if (guessedChars.has(char)) {
            span.className = 'char';
            span.classList.add('revealed');
            span.textContent = char;
            span.style.backgroundColor = 'gray';
            span.id = 'lyrics';
          }
          else {
            span.className = 'char';
            span.textContent = 'ã€€'; // å…¨å½¢ç©ºç™½ç¶­æŒå¯¬åº¦
          }
          lyricsContainer.appendChild(span);
        }
        lyricsContainer.appendChild(document.createElement('br'));
      }
    }

    // è™•ç†è¼¸å…¥
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const value = input.value.trim();
        input.value = '';
        if (!value) return;


        if (value.length === 1) {
          if(guessedChars.has(value)||wrongChars.has(value))
          {
            log.textContent = `é€™å€‹å­—å·²ç¶“å•éäº†!`
          }
          else if (full_lyrics.includes(value)) {
            guessCount++;
            guessedChars.add(value);
            guessed.textContent = "çŒœå°çš„å­—ï¼š" + Array.from(guessedChars).join(" ");
            renderLyrics();
            log.textContent = `ç™¼ç¾æ­Œè©ä¸­æœ‰ã€Œ${value}ã€é€™å€‹å­—ï¼(å…±çŒœäº† ${guessCount} æ¬¡)`;
          }
          else {
            guessCount++;
            wrongChars.add(value);
            wrong.textContent = "çŒœéŒ¯çš„å­—ï¼š" + Array.from(wrongChars).join(" ");
            log.textContent = `æ­Œè©ä¸­æ²’æœ‰ã€Œ${value}ã€é€™å€‹å­—å–”ï½ (å…±çŒœäº† ${guessCount} æ¬¡)`;
          }
        } else {
          if (value === songTitle) {
            log.textContent = `ğŸ‰ æ­å–œä½ çŒœåˆ°æ­£ç¢ºçš„æ­Œåï¼šã€Œ${songTitle}ã€ï¼ä½ ç¸½å…±çŒœäº† ${guessCount} æ¬¡`;
            guessedChars = new Set(lyrics.join('')); // å…¨éƒ¨é¡¯ç¤º
            renderLyrics();
            window.open("https://www.youtube.com/results?search_query="+songTitle, '_blank').focus();
            lyricsContainer.innerHTML += `  <input type="button" onclick="restart()" value="å†ä¾†ä¸€å ´">`;
          } else {
            log.textContent = `ä¸æ˜¯é€™é¦–æ­Œ ğŸ˜¢èœé›`;
          }
        }
      }
    });


    function show_all() {
      guessedChars = new Set(lyrics.join('')); // å…¨éƒ¨é¡¯ç¤º
      renderLyrics();
      window.open("https://www.youtube.com/results?search_query="+songTitle, '_blank').focus();
      lyricsContainer.innerHTML += `  <div><input type="button" onclick="restart()" value="å†ä¾†ä¸€å ´"></div>`;
    }

    renderLyrics();
	
  </script>
</body>
</html>
